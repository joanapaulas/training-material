<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Galaxy Training!</title>
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <link rel="stylesheet" href="/training-material/assets/css/font-awesome.css">
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="stylesheet" href="/training-material/assets/css/syntax_highlighting.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />
    </head>
    <body>
        




<header>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/training-material/topics/dev" title="Go back to list of tutorials">
                            <i class="fa fa-folder-o" aria-hidden="true"></i> Development in Galaxy
                        </a>
                    </li>

                    
                        
                        
                        
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Introduction slides">
                                    <i class="fa fa-slideshare" aria-hidden="true"></i> Introduction slides
                                </a>
                                <div class="dropdown-menu">
                                    
                                        
                                            
                                                <a class="dropdown-item" href="/training-material/topics/dev/slides/introduction.html">
                                                    Galaxy from a developer point of view
                                                </a>
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                    
                                </div>
                            </li>
                        
                    

                    

                    

                    
                    <li class="nav-item">
                        <a class="nav-link" href="" title="Links to data">
                            <i class="fa fa-files-o" aria-hidden="true"></i> Input Dataset
                        </a>
                    </li>
                    

                    

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="fa fa-life-ring" aria-hidden="true"></i> Help
    </a>
    <div class="dropdown-menu">
        <a class="dropdown-item" href="https://gitter.im/Galaxy-Training-Network/Lobby" title="Chat on Gitter">
            Gitter
        </a>
        <a class="dropdown-item" href="https://biostar.usegalaxy.org/" title="Ask on Biostars">
            Biostars
        </a>
    </div>
</li>


                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/galaxyproject/training-material/tree/master/topics/dev/tutorials/visualization-generic/tutorial.md">
                            <i class="fa fa-github" aria-hidden="true"></i> Edit
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="container main-content">
    <section class="tutorial">
        <h1>Visualizations: generic plugins</h1>

        <blockquote class="overview">
            <h3>Overview</h3>

            <strong><i class="fa fa-question-circle" aria-hidden="true"></i> Questions</strong>
            <ul>
            
            <li>How can visualization plugins benefit science?</li>
            
            </ul>

            <strong><i class="fa fa-bullseye" aria-hidden="true"></i> Objectives</strong>
            <ul>
            
            <li>Implement a first Galaxy visualization</li>
            
            <li>Understand the client side vs. server side principle</li>
            
            </ul>

            
            <strong><i class="fa fa-check-circle" aria-hidden="true"></i> Requirements</strong>
            <ul>
            
            
                <li>
                    
                    <a href="">Javascript knowledge</a>
                    
                </li>
            
            </ul>
            

            <p><strong><i class="fa fa-hourglass-end" aria-hidden="true"></i> Time estimation:</strong> 1.5h</p>
        </blockquote>

        <h1 class="no_toc" id="introduction">Introduction</h1>

<p>Visualizations may be very helpful in understanding data better. There is a whole
range of visualizations, from rather simple scatter and barplots up to projections
of high dimensional data or even entire genomes. Many of these visualizations often
require a lot of tweaking and changes in settings like zooming in and assigning colors, etc.
Therefore, visualizations are ideally interactive, and changing settings is often
an initial step in exploring data. For this reason it may be inconvenient to make use
of static galaxy tools because it lacks these interactive features. For these situations Galaxy
offers the option to create <em>visualizations plugins</em>, file format specific javascripts
that integrate with the history menu, without making redundant copies of data.</p>

<p>In this tutorial we shall go through how this system works and create a simple visualization
plugin. The tool will create a visualization of the number of aligned reads per
chromosome of a BAM file, and we will discuss possible optimizations and advantages
and disadvantages of the proposed implementation.</p>

<p>If you want to make visualizations ready for production, it is essential to have a good
understanding of HTML5 and JavaScript as these are the basic languages in which they are written.
However, for this tutorial we will keep it basic.</p>

<p>Additional documentation about Galaxy visualizations can be found here:</p>

<ul>
  <li><a href="https://galaxyproject.org/visualizations-registry">VisualizationsRegistry</a></li>
  <li><a href="https://galaxyproject.org/visualizations-registry/cookbook">VisualizationsRegistry/Cookbook</a></li>
  <li><a href="https://galaxyproject.org/visualizations-registry/code">VisualizationsRegistry/Code</a></li>
  <li><a href="https://galaxyproject.org/data-providers">DataProviders</a></li>
  <li><a href="https://galaxyproject.org/data-providers/cookbook">DataProviders/Cookbook</a></li>
  <li><a href="https://galaxyproject.org/develop/visualizations">Develop/Visualizations</a></li>
</ul>

<blockquote class="agenda">
  <h3 id="agenda">Agenda</h3>

  <p>In this tutorial, we will deal with:</p>

<ol id="markdown-toc">
  <li><a href="#part-1" id="markdown-toc-part-1">Part 1</a>    <ol>
      <li><a href="#linking-the-plugin-with-galaxy" id="markdown-toc-linking-the-plugin-with-galaxy">Linking the plugin with Galaxy</a></li>
      <li><a href="#creating-the-visualization" id="markdown-toc-creating-the-visualization">Creating the visualization</a></li>
    </ol>
  </li>
</ol>

</blockquote>

<h1 id="part-1">Part 1</h1>

<p>The visualization we are going to create in this tutorial, is a tool that shows the number of aligned
reads per chromosome of a BAM file. The first thing we need to do is to come up with a name.
Let’s call it <em>alignment_rname_boxplot</em>. Note that the reference sequences (usually chromosomes)
to which we align are named <code class="highlighter-rouge">RNAME</code> in the BAM/SAM specification.</p>

<p>The development of a Galaxy visualization takes place within the Galaxy codebase.</p>

<blockquote class="hands_on">
  <h3 id="-hands-on-data-upload"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on: Data upload</h3>

  <ol>
    <li>Clone an instance of Galaxy in a path, further referred to as <code class="highlighter-rouge">$GALAXY_ROOT</code></li>
    <li>
      <p>Explore the plugin directory as follows:</p>

      <div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span><span class="nb">cd</span> <span class="nv">$GALAXY_ROOT</span>/config/plugins/visualizations
</code></pre>
      </div>
    </li>
    <li>
      <p>Create a new directory for our new plugin project</p>

      <div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>mkdir alignment_rname_boxplot
<span class="gp">$ </span><span class="nb">cd </span>alignment_rname_boxplot
</code></pre>
      </div>
    </li>
    <li>
      <p>Make three (sub-)directories to complete the structure of the project:</p>

      <div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>mkdir config
<span class="gp">$ </span>mkdir static
<span class="gp">$ </span>mkdir templates
</code></pre>
      </div>
    </li>
  </ol>
</blockquote>

<h2 id="linking-the-plugin-with-galaxy">Linking the plugin with Galaxy</h2>

<p>To create a bridge between our not-yet-written plugin and Galaxy, we need to write a
configuration in XML format.</p>

<blockquote class="hands_on">
  <h3 id="-hands-on-data-upload-1"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on: Data upload</h3>

  <p>Create the file  <code class="highlighter-rouge">config/alignment_rname_boxplot.xml</code> with the following contents:</p>

  <div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE visualization SYSTEM "../../visualization.dtd"&gt;</span>
<span class="nt">&lt;visualization</span> <span class="na">name=</span><span class="s">"alignment_rname_boxplot"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;data_sources&gt;</span>
        <span class="nt">&lt;data_source&gt;</span>
            <span class="nt">&lt;model_class&gt;</span>HistoryDatasetAssociation<span class="nt">&lt;/model_class&gt;</span>

            <span class="nt">&lt;test</span> <span class="na">type=</span><span class="s">"isinstance"</span> <span class="na">test_attr=</span><span class="s">"datatype"</span> <span class="na">result_type=</span><span class="s">"datatype"</span><span class="nt">&gt;</span>binary.Bam<span class="nt">&lt;/test&gt;</span>
            <span class="nt">&lt;test</span> <span class="na">type=</span><span class="s">"isinstance"</span> <span class="na">test_attr=</span><span class="s">"datatype"</span> <span class="na">result_type=</span><span class="s">"datatype"</span><span class="nt">&gt;</span>tabular.Sam<span class="nt">&lt;/test&gt;</span>

            <span class="nt">&lt;to_param</span> <span class="na">param_attr=</span><span class="s">"id"</span><span class="nt">&gt;</span>dataset_id<span class="nt">&lt;/to_param&gt;</span>
        <span class="nt">&lt;/data_source&gt;</span>
    <span class="nt">&lt;/data_sources&gt;</span>
    <span class="nt">&lt;params&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">type=</span><span class="s">"dataset"</span> <span class="na">var_name_in_template=</span><span class="s">"hda"</span> <span class="na">required=</span><span class="s">"true"</span><span class="nt">&gt;</span>dataset_id<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;/params&gt;</span>
    <span class="nt">&lt;template&gt;</span>alignment_rname_boxplot.mako<span class="nt">&lt;/template&gt;</span>
<span class="nt">&lt;/visualization&gt;</span>
</code></pre>
  </div>

</blockquote>

<p>This configures the plugin’s name, which shall appear on pressing the visualization button in
the history menu. It also links the plugin to two file formats: BAM and SAM, which means that
for any history item of these file formats the plugin will automatically become available.</p>

<p>It also includes a reference to a mako template file (HTML + Python syntax), to be found in the
<code class="highlighter-rouge">templates</code> directory (we will create this file in the next section). The <code class="highlighter-rouge">var_name_in_template</code>
parameter is set to the value <code class="highlighter-rouge">hda</code>, which will be the name of the variable in the mako template
corresponding to the dataset to be visualized.</p>

<h2 id="creating-the-visualization">Creating the visualization</h2>

<p>We have linked our visualization to a mako file (which we have not yet created). This file is a
blueprint for the visualization. This means that for every invocation of the visualization, the
mako file will be compiled to render an HTML file.</p>

<p>Beause we would like the visualization to load quickly, computationally intensive tasks should
not be done prior to loading. A bit of server-side rendering in itself is not a problem, but the
visualizations (written in HTML and/or JS) should do most of the actual calculations and
conversions on the client side (in the browser). Therefore, unlike regular Galaxy tools, parsing
files does not take place on the server, but instead data will be downloaded by the client via an
exposed Galaxy URL prior to client-side rendering.</p>

<p>The most basic part of the mako file are the variables used for further web development, given
below.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="err">&lt;</span>%
    import os

    ## Generates hash (hdadict['id']) of history item
    hdadict = trans.security.encode_dict_ids( hda.to_dict() )

    ## Finds the parent directory of galaxy (/, /galaxy, etc.)
    root     = h.url_for( '/' )

    ## Determines the exposed URL of the ./static directory
    app_root = root + 'plugins/visualizations/'+visualization_name+'/static/'

    ## Actual file URL:
    file_url = os.path.join(root, 'datasets', hdadict['id'], "display?to_ext="+hda.ext)
%&gt;
</code></pre>
</div>

<ul>
  <li><code class="highlighter-rouge">hdadict</code> is a variable that contains a file identifier that has been encoded to it’s
 exposed uid.</li>
  <li><code class="highlighter-rouge">root</code> indicates location of Galaxy on the webserver (e.g. <code class="highlighter-rouge">/</code>, <code class="highlighter-rouge">/galaxy/</code>, <code class="highlighter-rouge">/galaxy-pub/</code>, etc).</li>
  <li><code class="highlighter-rouge">app_root</code> contains the exposed url of the static files for this visualization.</li>
  <li><code class="highlighter-rouge">file_url</code> contains the exposed url of the dataset selected (by user) for visualization.</li>
</ul>

<p>We could obtain the BAM file client-side by downloading the BAM/SAM file in its entirety via
<em>file_url</em>. However, BAM files can become quite large and it is usually not desired to transfer
such datasets over the network. In our case it is also rather inconvenient to parse the BAM file
with Javascript, just to count the number of reads.</p>

<p>Fortunately, BAM files have indices. These indices are brief summaries describing the
number of entries per chromosome, in order to be able to access the data contained in them more
quickly. In the mako template we can access a BAM index as <em>hda.metadata.bam_index</em>.
(Note that this is a file path on the server, not an exposed URL).</p>

<p>Samtools has a command named <code class="highlighter-rouge">idxstats</code> which is able to leverage this BAM index you. However,
since visualizations do not have dependency management, it is very tricky to let the mako template
do a system call to samtools. Fortunately, the Galaxy ecosystem ships with a built-in <code class="highlighter-rouge">pysam</code>
dependency, a library that can do any native samtools command within python.</p>

<p>The <code class="highlighter-rouge">*.metadata.bam_index</code> is a special kind of file in the Galaxy ecosystem. It is actually an
invisible file in Galaxy, linked to another history item, but does have a unique filename.
So, for the BAM file <code class="highlighter-rouge">./database/files/000/dataset_001.dat</code>, our BAI file (index) is <strong>not</strong>
<code class="highlighter-rouge">./database/files/000/dataset_001.dat.bai</code> but could be <code class="highlighter-rouge">./database/files/000/dataset_002.dat</code> or
<code class="highlighter-rouge">./database/files/000/dataset_003.dat</code>. We can create a symlink to this index file to ensure the
bam file and its index share the same prefix, as expected by samtools and pysam.</p>

<p>We can create this symlink as follows in our mako template:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">## Ensure BAI index is symlinked</span>
<span class="n">bai_target</span> <span class="o">=</span> <span class="n">hda</span><span class="o">.</span><span class="n">file_name</span><span class="o">+</span><span class="s">'.bai'</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">bai_target</span><span class="p">):</span>
   <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">hda</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bam_index</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="n">bai_target</span><span class="p">)</span>
</code></pre>
</div>

<p>Now the BAM file has a <code class="highlighter-rouge">.bai</code> file with the same prefix, and we can run the <code class="highlighter-rouge">idxstats</code>
as follows:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">## Extract idxstats</span>
<span class="kn">import</span> <span class="nn">pysam</span>
<span class="n">bam_idxstats_data</span> <span class="o">=</span> <span class="n">pysam</span><span class="o">.</span><span class="n">idxstats</span><span class="p">(</span><span class="n">hda</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
</code></pre>
</div>

<p>With the lines of python code above, the idxstats data is parsed into the RAM of python
during compilation on the server, but is not yet exported into the HTML page nor parsed by JS.
To do that, we add an HTML section to the end of the mako file.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>${hda.name | h} | ${visualization_name | h}<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        ${bam_idxstats_data | h}
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p>Here you see <code class="highlighter-rouge">${bam_idxstats_data | h}</code>, which prints the python variable into
the HTML page and also does HTML escaping by providing the ` | h`-flag (for security reasons).</p>

<p>Let’s put this all together.</p>

<blockquote class="hands_on">
  <h3 id="-hands-on-data-upload-2"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on: Data upload</h3>

  <ol>
    <li>Create the mako file <code class="highlighter-rouge">templates/alignment_rname_boxplot.mako</code></li>
    <li>
      <p>Fill it with the following code:</p>

      <div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="err">&lt;</span>%
    import os
   
    ## Generates hash (hdadict['id']) of history item
    hdadict = trans.security.encode_dict_ids( hda.to_dict() )
   
    ## Finds the parent directory of galaxy (/, /galaxy, etc.)
    root     = h.url_for( '/' )
   
    ## Determines the exposed URL of the ./static directory
    app_root = root + 'plugins/visualizations/'+visualization_name+'/static/'
   
    ## Actual file URL:
    file_url = os.path.join(root, 'datasets', hdadict['id'], "display?to_ext="+hda.ext)
   
    ## Ensure BAI index is symlinked
    bai_target = hda.file_name+'.bai'
   
    if not os.path.isfile(bai_target):
        os.symlink(hda.metadata.bam_index.file_name, bai_target)
   
    ## Extract idxstats
    import pysam
    bam_idxstats_data = pysam.idxstats(hda.file_name)
%&gt;
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>${hda.name | h} | ${visualization_name | h}<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        ${bam_idxstats_data | h}
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
      </div>

      <p>We are now ready to test this very basic visualization, we just need a (small) BAM file for it.</p>
    </li>
    <li>Download <a href="https://zenodo.org/record/248730/files/tutorial.bam">the example BAM file</a></li>
    <li>
      <p>Go the galaxy root directory and start Galaxy:</p>

      <div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span><span class="nb">cd</span> <span class="nv">$GALAXY_ROOT</span>
<span class="gp">$ </span>./run.sh
</code></pre>
      </div>
    </li>
    <li>
      <p>Upload the example BAM file to your history</p>

      <p>If everything went well, our plugin has appeared as a visualization option for the dataset</p>

      <blockquote class="comment">
        <h3 id="-comments"><i class="fa fa-commenting-o" aria-hidden="true"></i> Comments</h3>
        <p>You must be logged in to be able to use visualizations</p>
      </blockquote>
    </li>
  </ol>

</blockquote>

<p>All the visualization does at the moment, is show the contents of idxstats, compiled to HTML:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>['chrA\t5386\t2\t0\n', 'chrB\t5386\t4\t0\n', 'chrC\t5386\t1\t0\n', 'chrD\t5386\t6\t1\n',
'chrE\t5386\t3\t0\n', 'chrF\t5386\t2\t0\n', 'chrG\t5386\t1\t0\n', '*\t0\t0\t0\n']
</code></pre>
</div>

<p>It contains eight entries, one for each of our (made-up) chromosomes and one to <code class="highlighter-rouge">*</code>, which represents
the unmapped reads. Entries are tab delimited (<code class="highlighter-rouge">\t</code>) and for the <code class="highlighter-rouge">chrA</code> entry it indicates that the
length of the RNAME (chromosome) is 5386 bases and 2 reads are aligned to it.</p>

<p>To make the data a bit more usable for Javascript , we convert it into a simple dictionary
of the following syntax:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="s">'chrA'</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s">'chrB'</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="s">'chrC'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">'chrD'</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s">'chrE'</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s">'chrF'</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s">'chrG'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">'*'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</code></pre>
</div>

<p>Although it is possible to do this in python we recommend doing this in JS.
The var dump provided by python/pysam is actually a valid syntax for Javascript too,
so getting the raw data into Javascript is rather easy:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
    <span class="nx">bam_idxstats_data</span> <span class="o">=</span> <span class="nx">$</span><span class="p">{</span><span class="nx">bam_idxstats_data</span><span class="p">};</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre>
</div>

<p>Converting the data is not the scope of the tutorial, so here we provide such a function:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
  <span class="nx">bam_idxstats_data</span> <span class="o">=</span> <span class="nx">$</span><span class="p">{</span><span class="nx">bam_idxstats_data</span><span class="p">};</span>
  <span class="kd">function</span> <span class="nx">parse_data</span><span class="p">(</span><span class="nx">bam_idxstats_data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">chunks</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">"\t"</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">"_"</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// only if it does not contain underscore</span>
        <span class="nx">output</span><span class="p">[</span><span class="nx">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>

   <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">&lt;/script&gt;</span>
</code></pre>
</div>

<p>The great thing about the mako system is that it does not require to restart galaxy in order to make
functional changes to the mako files.</p>

<blockquote class="hands_on">
  <h3 id="-hands-on-data-upload-3"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on: Data upload</h3>

  <ol>
    <li>
      <p>Change the mako file to the following:</p>

      <div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="err">&lt;</span>%
    import os
   
    ## Generates hash (hdadict['id']) of history item
    hdadict = trans.security.encode_dict_ids( hda.to_dict() )
   
    ## Finds the parent directory of galaxy (/, /galaxy, etc.)
    root     = h.url_for( '/' )
   
    ## Determines the exposed URL of the ./static directory
    app_root = root + 'plugins/visualizations/'+visualization_name+'/static/'
   
    ## Actual file URL:
    file_url = os.path.join(root, 'datasets', hdadict['id'], "display?to_ext="+hda.ext)
   
    ## Ensure BAI index is symlinked
    bai_target = hda.file_name+'.bai'
   
    if not os.path.isfile(bai_target):
        os.symlink(hda.metadata.bam_index.file_name, bai_target)
   
    ## Extract idxstats
    import pysam
    bam_idxstats_data = pysam.idxstats(hda.file_name)
   
%&gt;
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
       <span class="nt">&lt;title&gt;</span>${hda.name | h} | ${visualization_name | h}<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;script&gt;</span>
            <span class="nx">bam_idxstats_data</span> <span class="o">=</span> <span class="nx">$</span><span class="p">{</span><span class="nx">bam_idxstats_data</span><span class="p">};</span>
            <span class="kd">function</span> <span class="nx">parse_data</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="kd">var</span> <span class="nx">chunks</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">"\t"</span><span class="p">);</span>
   
                    <span class="k">if</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">"_"</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// only if it does not contain underscore</span>
                        <span class="nx">output</span><span class="p">[</span><span class="nx">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body</span> <span class="na">onload=</span><span class="s">"bam_idxstats = parse_data(bam_idxstats_data);"</span><span class="nt">&gt;</span>
        ${bam_idxstats_data | h}
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
      </div>
    </li>
    <li>
      <p>Retrigger the visualization and open the developers console of your browser: In the console, type: <code class="highlighter-rouge">bam_idxstats_data</code> and press [Enter]
  This should give the parsed contents as a dictionary, which can directly be used in Javascript.</p>
    </li>
  </ol>

</blockquote>

<p>From this point forward you are encouraged to continue on your own to see if you are able to create
a simple visualization from this dictionary. Think of tables, DIVs or even more complicated
solutions :).</p>

<p>Below is an example visualization, which creates a bar plot showing the number of reads per
chromosome.</p>

<p><img src="../../images/vis_plugins_example.png" alt="Example visualization" /></p>

<p>The full contents of this plugin are provided in the <a href="https://github.com/galaxyproject/training-material/tree/master/topics/dev/files/hands_on-visualizations/alignment_rname_boxplot">GitHub repository related to this material in <code class="highlighter-rouge">tree/master/topics/dev/files/hands_on-visualizations/alignment_rname_boxplot</code></a>.
To try out this example, simply copy this folder to the <code class="highlighter-rouge">$GALAXY_ROOT/config/plugins/visualizations/</code> folder
on your (local) Galaxy and restart Galaxy.</p>

<p>The contents of the mako file for this example are given below.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="err">&lt;</span>%
    import os

    ## Generates hash (hdadict['id']) of history item
    hdadict = trans.security.encode_dict_ids( hda.to_dict() )

    ## Finds the parent directory of galaxy (/, /galaxy, etc.)
    root     = h.url_for( '/' )

    ## Determines the exposed URL of the ./static directory
    app_root = root + 'plugins/visualizations/'+visualization_name+'/static/'

    ## Actual file URL:
    file_url = os.path.join(root, 'datasets', hdadict['id'], "display?to_ext="+hda.ext)

    ## Ensure BAI index is symlinked
    bai_target = hda.file_name+'.bai'

    if not os.path.isfile(bai_target):
        os.symlink(hda.metadata.bam_index.file_name, bai_target)

    ## Extract idxstats
    import pysam
    bam_idxstats_data = pysam.idxstats(hda.file_name)
%&gt;
<span class="nt">&lt;html&gt;</span>
     <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>${hda.name | h} | ${visualization_name | h}<span class="nt">&lt;/title&gt;</span>

        <span class="nt">&lt;style&gt;</span>
             <span class="nc">.chart</span> <span class="nt">div</span> <span class="p">{</span>
               <span class="nl">font</span><span class="p">:</span> <span class="m">10px</span> <span class="nb">sans-serif</span><span class="p">;</span>
               <span class="nl">background-color</span><span class="p">:</span> <span class="no">steelblue</span><span class="p">;</span>
               <span class="nl">text-align</span><span class="p">:</span> <span class="nb">right</span><span class="p">;</span>
               <span class="nl">padding</span><span class="p">:</span> <span class="m">3px</span><span class="p">;</span>
               <span class="nl">margin</span><span class="p">:</span> <span class="m">1px</span><span class="p">;</span>
               <span class="nl">color</span><span class="p">:</span> <span class="no">white</span><span class="p">;</span>
             <span class="p">}</span>
        <span class="nt">&lt;/style&gt;</span>
        <span class="nt">&lt;script&gt;</span>
            <span class="nx">bam_idxstats_data</span> <span class="o">=</span> <span class="nx">$</span><span class="p">{</span><span class="nx">bam_idxstats_data</span><span class="p">};</span>
            <span class="kd">function</span> <span class="nx">parse_data</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                 <span class="cm">/*
                  Data comes in as tuple of unsplit lines:
                  ["chr1\t1000\t0\t0", "chr2\t2500\t0\t0"]

                  We need to split it up, and ideally only keep reference names without an underscore
                 */</span>
                 <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">{};</span>

                 <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                     <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                     <span class="kd">var</span> <span class="nx">chunks</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">"\t"</span><span class="p">);</span>

                     <span class="k">if</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">"_"</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// only if it does not contain underscore</span>
                         <span class="nx">output</span><span class="p">[</span><span class="nx">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                     <span class="p">}</span>
                 <span class="p">}</span>

                 <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nx">calc_stats</span><span class="p">(</span><span class="nx">parsed</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parsed</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">parsed</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">max</span><span class="p">){</span>
                        <span class="nx">max</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
                    <span class="p">}</span>
                    <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">parsed</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="p">[</span><span class="nx">max</span><span class="p">,</span> <span class="nx">sum</span><span class="p">];</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nx">plot_data</span><span class="p">(</span><span class="nx">parsed</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">max</span> <span class="o">=</span> <span class="nx">calc_stats</span><span class="p">(</span><span class="nx">parsed</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
                <span class="kd">var</span> <span class="nx">sum</span> <span class="o">=</span> <span class="nx">calc_stats</span><span class="p">(</span><span class="nx">parsed</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parsed</span><span class="p">)</span> <span class="p">{</span>
                     <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
                     <span class="kd">var</span> <span class="nx">ratio</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="nx">value</span> <span class="o">/</span> <span class="nx">sum</span><span class="p">;</span>
                     <span class="kd">var</span> <span class="nx">ratio2</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="nx">value</span> <span class="o">/</span> <span class="nx">max</span><span class="p">;</span>

                     <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"div"</span><span class="p">);</span>
                     <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'&lt;nobr&gt;'</span><span class="o">+</span><span class="nx">key</span><span class="o">+</span><span class="s1">'&lt;/nobr&gt;'</span><span class="p">;</span>
                     <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"chart_names"</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>

                     <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"div"</span><span class="p">);</span>
                     <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'&lt;nobr&gt;'</span><span class="o">+</span><span class="nx">value</span><span class="o">+</span><span class="s2">" ("</span><span class="o">+</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ratio</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="o">+</span><span class="s2">"%)&lt;/nobr&gt;"</span><span class="p">;</span>
                     <span class="nx">div</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">key</span><span class="o">+</span><span class="s1">': '</span><span class="o">+</span><span class="nx">value</span><span class="o">+</span><span class="s2">" ("</span><span class="o">+</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ratio</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="o">+</span><span class="s2">"%)"</span><span class="p">;</span>
                     <span class="nx">div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span>  <span class="nx">ratio2</span><span class="o">+</span><span class="s1">'%'</span><span class="p">;</span>
                     <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"chart"</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="nt">&lt;/script&gt;</span>
     <span class="nt">&lt;/head&gt;</span>
     <span class="nt">&lt;body</span> <span class="na">onload=</span><span class="s">"plot_data(parse_data(bam_idxstats_data));"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;center&gt;</span>
             <span class="nt">&lt;h1&gt;</span>Bam contents of ${hda.name | h}<span class="nt">&lt;/h1&gt;</span>

             <span class="nt">&lt;table</span> <span class="na">border=</span><span class="s">"0"</span> <span class="na">borderpadding=</span><span class="s">"0"</span> <span class="na">borderpanning=</span><span class="s">")"</span> <span class="na">style=</span><span class="s">"width: 500px;"</span><span class="nt">&gt;</span>
                 <span class="nt">&lt;tr&gt;</span>
                     <span class="nt">&lt;td</span> <span class="na">style=</span><span class="s">"width:50px;"</span><span class="nt">&gt;</span>
                         <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"chart_names"</span> <span class="na">class=</span><span class="s">"chart"</span> <span class="na">style=</span><span class="s">"width: 100%; border: 1px dashed gray;text-align: left;"</span> <span class="nt">/&gt;</span>
                     <span class="nt">&lt;/td&gt;</span>
                     <span class="nt">&lt;td</span> <span class="na">style=</span><span class="s">"width:450px;"</span><span class="nt">&gt;</span>
                         <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"chart"</span> <span class="na">class=</span><span class="s">"chart"</span> <span class="na">style=</span><span class="s">"width:100%; border: 1px dashed gray;text-align: left;"</span> <span class="nt">/&gt;</span>
                     <span class="nt">&lt;/td&gt;</span>
                 <span class="nt">&lt;/tr&gt;</span>
             <span class="nt">&lt;/table&gt;</span>
         <span class="nt">&lt;/center&gt;</span>
     <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</code></pre>
</div>

<p>In the given example, the <code class="highlighter-rouge">RNAME</code> queries containing an underscore were removed.
This is because there are many alternative chromosomes, making the list very large
for certain reference genomes. However, for certain studies it might be desired to
just look at those.</p>

<p>The current plot is a box plot, but one can imagine a pie-chart may be convenient too.
All of those additional settings can be implemented for interactive behaviour,
contributing to quicker understanding of the data which is generally not so convenient
using static Galaxy tools.</p>

<blockquote class="tip">
  <h3 id="-tip-static-files"><i class="fa fa-lightbulb-o" aria-hidden="true"></i> Tip: Static files</h3>

  <p>In the example we included Javascript and CSS into the HTML website.
Remember that for every new invocation of the visualization the entire CSS en JS are copied
and transferred as well. This is a waste of (redundant) bandwidth as we could save the
files in the static directory and refer to them within the HTML. The browser shall check
it’s cache for the presence of libs and style sheets and only update them if they have changed.</p>
</blockquote>

<h3 id="improvements">Improvements</h3>

<p>Another thing you may realize is that we still do the calculation (pysam.idxstats) server side.
Although this is a marginal calculation, it is causing delay and the bigger the files, the worse
this delay becomes. The underlying problem is that we did not obtain and parse the BAI file via
Javascript. This would be a more elaborate solution, but requires more development time as we
need to develop a function able to parse the binary file.</p>

<p>Another thing we could do is create a static <code class="highlighter-rouge">samtools idxstats</code> tool, that creates a file of
datatype <code class="highlighter-rouge">tabular.Idxstats</code> and include that datatype into Galaxy. We then make the visualization
specific for that datatype, just plotting the results of the <code class="highlighter-rouge">idxstats</code>.</p>

<p>A fundamental and more complicated problem is that BAM files are simply too big to transfer for
these kind of applications. It would be ideal to have web server integration that allows querying
of specific locations or metadata within or from a BAM file where indexing operations are taken
care of at the server side. This is what has been done in Trackster.</p>

<h3 id="more-examples">More examples</h3>

<p>For more examples of visualization plugins, you can browse this
<a href="https://github.com/bgruening/galaxytools/tree/master/visualisations">GitHub repo</a></p>

<h1 class="no_toc" id="conclusion">Conclusion</h1>

<p>We have just created a visualization plugin in Galaxy to visualize the number of alignments
per <code class="highlighter-rouge">RNAME</code> (chromosome) in a BAM file.</p>


        
        <blockquote class="key_points">
            <h3><i class="fa fa-key" aria-hidden="true"></i> Key points</h3>

            <ul>
                
                <li>Visualizations require a different way of thinking: server and client side; downloading files rather than system level access</li>
                
                <li>Interactivity is what makes visualizations different from static tools</li>
                
                <li>Requires understanding of both the Galaxy ecosystem as well as HTML5/JS</li>
                
                <li>Performance is more important than for static Galaxy tools</li>
                
            </ul>
        </blockquote>
        

        

        <h3><i class="fa fa-thumbs-up" aria-hidden="true"></i> Congratulations on successfully completing this tutorial!</h3>

        <hr>

        <blockquote class="overview">
            <h3><i class="fa fa-comments-o" aria-hidden="true"></i> Help us improve this content!</h3>
            Please take a moment to fill in the Galaxy Training Network
            <a href="https://tinyurl.com/GTNfeedback">Feedback Form</a>.
            Your feedback helps us improve this tutorial and will be considered
            in future revisions.
        </blockquote>
    </section>
</div>


<footer>
    <div class="container">
        <p>
            This material is the result of a collaborative work. Thanks to the
            <a href="https://wiki.galaxyproject.org/Teach/GTN">Galaxy Training Network</a>
            and all the <a href="/training-material/hall-of-fame">contributors</a> (Saskia Hiltemann, Youri Hoogstrate)!
        </p>
        <p>
            Found a typo? Something is wrong in this tutorial? Edit it on
            <a href="https://github.com/galaxyproject/training-material/tree/master/topics/dev/tutorials/visualization-generic/tutorial.md">GitHub</a>.
        </p>
    </div>
</footer>

    </body>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
    <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/training-material/assets/js/main.js"></script>
</html>
